gsutil rm -r gs://firestore_exports_101/* &&
gcloud firestore export gs://firestore_exports_101/export-01 --collection-ids=orders,client_positions && 
bq load --source_format=DATASTORE_BACKUP --replace turing_trades.client_positions_stg gs://firestore_exports_101/export-01/all_namespaces/kind_client_positions/all_namespaces_kind_client_positions.export_metadata &&
bq load --source_format=DATASTORE_BACKUP --replace turing_trades.orders_stg gs://firestore_exports_101/export-01/all_namespaces/kind_orders/all_namespaces_kind_orders.export_metadata &&
bq query --use_legacy_sql=false '''truncate table `boxwood-veld-298509.turing_trades.client_positions`''' &&
bq query --use_legacy_sql=false '''insert into `boxwood-veld-298509.turing_trades.client_positions`(position_total_sell_quantity,position_m2m,position_net_amount,position_sell_amount_mtm,position_average_sell_price_mtm,position_average_buy_price_mtm,position_buy_quantity,position_realised_pnl,position_exchange,position_net_quantity,position_sell_amount,position_product,position_multiplier,position_strike_price,position_sell_quantity,position_buy_amount,position_bep,position_unrealised_pnl,position_close_price_mtm,position_average_sell_price,position_cf_sell_quantity,position_total_buy_quantity,position_net_amount_mtm,position_ltp,position_average_buy_price,position_trading_symbol,position_instrument_token,position_buy_amount_mtm,position_close_price,position_cf_buy_quantity,position_cf_average_sell_price,position_enabled,position_cf_average_buy_price,position_client_id,date_w_id,broker,client_id,chat_id) select position.total_sell_quantity as position_total_sell_quantity,cast(replace(position.m2m,",","") as float64) as position_m2m,safe_cast(position.net_amount as float64) as position_net_amount,position.sell_amount_mtm as position_sell_amount_mtm,position.average_sell_price_mtm as position_average_sell_price_mtm,position.average_buy_price_mtm as position_average_buy_price_mtm,position.buy_quantity as position_buy_quantity,safe_cast(replace(position.realised_pnl,",","") as float64)as position_realised_pnl,position.exchange as position_exchange,position.net_quantity as position_net_quantity,position.sell_amount as position_sell_amount,position.product as position_product,position.multiplier as position_multiplier,position.strike_price as position_strike_price,position.sell_quantity as position_sell_quantity,position.buy_amount as position_buy_amount,position.bep as position_bep,position.unrealised_pnl as position_unrealised_pnl,position.close_price_mtm as position_close_price_mtm,position.average_sell_price as position_average_sell_price,position.cf_sell_quantity as position_cf_sell_quantity,position.total_buy_quantity as position_total_buy_quantity,safe_cast(position.net_amount_mtm as float64)as position_net_amount_mtm,position.ltp as position_ltp,position.average_buy_price as position_average_buy_price,position.trading_symbol as position_trading_symbol,position.instrument_token as position_instrument_token,position.buy_amount_mtm as position_buy_amount_mtm,position.close_price as position_close_price,position.cf_buy_quantity as position_cf_buy_quantity,position.cf_average_sell_price as position_cf_average_sell_price,position.enabled as position_enabled,position.cf_average_buy_price as position_cf_average_buy_price,position.client_id as position_client_id,date_w_id as date_w_id,broker as broker,client_id as client_id,chat_id as chat_id from `boxwood-veld-298509.turing_trades.client_positions_stg` ''' &&
bq query --use_legacy_sql=false 'insert into `boxwood-veld-298509.turing_trades.orders`(order_closed,order_duration,order_is_fut,order_is_CE,order_order_type,order_sl,order_trade_closed,order_transaction_type,order_segment,order_target,order_scrip,order_strike,source_telegram_m_id,source_telegram_reply_m_id,source_telegram_m_timestamp,source_telegram_channel,source_telegram_channel_type,source_telegram_channel_id,source_telegram_reply_to_message,source_telegram_message) SELECT order_closed,order_duration, `order`.is_fut AS order_is_fut,`order`.is_CE AS order_is_CE, `order`.order_type AS order_order_type,`order`.sl AS order_sl,`order`.trade_closed AS order_trade_closed,`order`.transaction_type AS order_transaction_type, `order`.segment AS order_segment,`order`.target AS order_target,`order`.scrip AS order_scrip, `order`.strike AS order_strike,source.telegram.m_id AS source_telegram_m_id,source.telegram.reply_m_id AS source_telegram_reply_m_id, source.telegram.m_timestamp AS source_telegram_m_timestamp,source.telegram.channel AS source_telegram_channel, source.telegram.channel_type AS source_telegram_channel_type, source.telegram.channel_id AS source_telegram_channel_id,source.telegram.reply_to_message AS source_telegram_reply_to_message, source.telegram.message AS source_telegram_message FROM `boxwood-veld-298509.turing_trades.orders_stg`' &&
gsutil rm -r gs://firestore_exports_101/* &&
firebase firestore:delete orders -r --project=boxwood-veld-298509 -y